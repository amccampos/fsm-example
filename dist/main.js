(()=>{var u=class{constructor(t){this.htmlCanvas=document.getElementById(t),this.htmlCanvas&&(this.context2d=this.htmlCanvas.getContext("2d"))}width(){return this.htmlCanvas.width}height(){return this.htmlCanvas.height}clear(){this.context2d.clearRect(0,0,this.htmlCanvas.width,this.htmlCanvas.height)}isOutside(t,s){return t<0||s<0||t>this.htmlCanvas.width||s>this.htmlCanvas.height}draw(t){this.context2d.fillStyle=t.fill||"rgb(40, 40, 120)",this.context2d.strokeStyle=t.stroke||"rgb(255, 255, 255)",this.context2d.beginPath(),this.context2d.arc(t.x,t.y,t.size,0,2*Math.PI),this.context2d.fill(),(t.type==="unit"||t.type==="player")&&(this.context2d.moveTo(t.x,t.y),this.context2d.lineTo(t.x+t.size*Math.cos(t.dir),t.y+t.size*Math.sin(t.dir)),this.context2d.stroke())}};var h=class{constructor(t,s,i,e,o=0,d=10,p=5){this.game=t,this.type=s,this.x=i,this.y=e,this.dir=o,this.size=d,this.speed=p,this.game.addGameObj(this)}update(){}draw(){}inBoundingBox(t,s){return t>=this.x-this.size&&t<=this.x+this.size&&s>=this.y-this.size&&s<=this.y+this.size}destroy(){this.game.removeGameObj(this)}};var x=class extends h{constructor(t,s,i){super(t,"gem",s,i);this.fill="rgb(255, 0, 0)"}draw(){let t=this.game.canvas.context2d;t.fillStyle="rgb(255, 0, 0)",t.strokeStyle="rgb(255, 255, 255)",t.beginPath(),t.moveTo(this.x,this.y+5),t.lineTo(this.x-10,this.y-5),t.lineTo(this.x-7,this.y-10),t.lineTo(this.x+7,this.y-10),t.lineTo(this.x+10,this.y-5),t.lineTo(this.x,this.y+5),t.fill(),t.stroke()}};var f=class extends h{constructor(t,s,i,e){super(t,"bullet",s,i,e,2,10);this.fill="rgb(255, 255, 255)"}update(){this.x+=this.speed*Math.cos(this.dir),this.y+=this.speed*Math.sin(this.dir),this.game.canvas.isOutside(this.x,this.y)&&this.destroy(),this.game.objs.find(t=>{t!==this&&t.inBoundingBox(this.x,this.y)&&(t.destroy(),this.destroy())})}draw(){let t=this.game.canvas.context2d;t.fillStyle="rgb(255, 255, 255)",t.strokeStyle="rgb(255, 255, 255)",t.beginPath(),t.arc(this.x,this.y,this.size,0,2*Math.PI),t.fill()}};var c=2*Math.PI/360,S=360/(2*Math.PI);function P(n,t=0){return Math.floor(Math.random()*(n-t+1))+t}function M(n,t=0){return Math.random()*(n-t)+t}function m(n,t,s,i){let e=s-n,o=i-t;return Math.sqrt(e*e+o*o)}function l(n,t,s,i=1){let e=n+i*Math.cos(s),o=t+i*Math.sin(s);return[e,o]}function g(n,t,s,i,e){let o=m(n,t,i,e),[d,p]=l(n,t,s,o),r=Math.atan2(e-t,i-n)-Math.atan2(p-t,d-n);return r<-Math.PI&&(r+=2*Math.PI),r>Math.PI&&(r-=2*Math.PI),r}var v=class extends h{constructor(t,s,i,e){super(t,"player",s,i,e);this.onLeft=!1,this.onRight=!1,this.onForward=!1,this.onFire=!1,this.armed=!0,document.addEventListener("keydown",o=>{switch(o.key){case"a":this.onLeft=!0;break;case"d":this.onRight=!0;break;case"w":this.onForward=!0;break;case" ":this.armed&&(this.onFire=!0,this.armed=!1);break}o.preventDefault()}),document.addEventListener("keyup",o=>{switch(o.key){case"a":this.onLeft=!1;break;case"d":this.onRight=!1;break;case"w":this.onForward=!1;break;case" ":this.armed=!0;break}o.preventDefault()})}update(){this.onLeft&&this.turnLeft(),this.onRight&&this.turnRight(),this.onForward&&this.moveForward(),this.onFire&&(this.fire(),this.onFire=!1)}moveForward(){let[t,s]=l(this.x,this.y,this.dir,this.speed);this.game.canvas.isOutside(t,s)||(this.x=t,this.y=s)}turnLeft(){this.dir-=this.speed*2*c}turnRight(){this.dir+=this.speed*2*c}fire(){let[t,s]=l(this.x,this.y,this.dir,this.size+5);new f(this.game,t,s,this.dir)}draw(){let t=this.game.canvas.context2d;t.fillStyle="rgb(36, 153, 72)",t.strokeStyle="rgb(255, 255, 255)",t.beginPath(),t.arc(this.x,this.y,this.size,0,2*Math.PI),t.fill(),t.moveTo(this.x,this.y),t.lineTo(this.x+this.size*Math.cos(this.dir),this.y+this.size*Math.sin(this.dir)),t.stroke()}};var y=class{constructor(t,s,i){this.action=t,this.entryAction=s,this.exitAction=i}},a=class{constructor(t,s,i,e){this.from=t,this.to=s,this.condition=i,this.action=e}},w=class{constructor(t,s=[]){this.state=t,this.transitions=s}update(t){this.state.action.apply(t);let s=this.transitions.filter(i=>i.from===this.state).find(i=>i.condition.apply(t));s&&(this.state.exitAction&&this.state.exitAction.apply(t),s.action&&s.action.apply(t),this.state=s.to,this.state.entryAction&&this.state.entryAction.apply(t))}};var T=class extends h{constructor(t,s,i,e){super(t,"unit",s,i,e);this.precious=this.game.objs.find(o=>o.type==="gem"),this.enemy=this.game.objs.find(o=>o.type==="player"),this.patrolPoints=[{x:this.precious.x-50,y:this.precious.y-50},{x:this.precious.x+50,y:this.precious.y-50},{x:this.precious.x+50,y:this.precious.y+50},{x:this.precious.x-50,y:this.precious.y+50}],this.currentPoint=0,this.initMatrixBasedFSM()}turnToPoint(){let t=this.patrolPoints[this.currentPoint];this.turnTo(t.x,t.y)}moveForward(){let[t,s]=l(this.x,this.y,this.dir,this.speed);this.game.canvas.isOutside(t,s)||(this.x=t,this.y=s)}chasePlayer(){this.turnTo(this.enemy.x,this.enemy.y),this.moveForward()}initConditionBasedFSM(){this.state="turnToPoint",this.update=this.updateUsingConditions}updateUsingConditions(){switch(this.state){case"turnToPoint":this.turnToPoint(),this.isFacingPoint()?this.state="moveToPoint":this.isPlayerCloseToGem()&&(this.state="chasePlayer");break;case"moveToPoint":this.moveForward(),this.isOverPoint()?(this.nextPoint(),this.state="turnToPoint"):this.isPlayerCloseToGem()&&(this.state="chasePlayer");break;case"chasePlayer":this.chasePlayer(),this.isPlayerFarFromGem()&&(this.state="turnToPoint");break}}initMatrixBasedFSM(){this.states=[this.turnToPoint,this.moveForward,this.chasePlayer],this.entryAction=[this.nextPoint,null,null],this.transitions=[[null,this.isFacingPoint,this.isPlayerCloseToGem],[this.isOverPoint,null,this.isPlayerCloseToGem],[this.isPlayerFarFromGem,null,null]],this.stateIndex=0,this.update=this.updateUsingMatrix}updateUsingMatrix(){this.states[this.stateIndex].apply(this);let i=this.transitions[this.stateIndex].findIndex(e=>e&&e.apply(this));if(i>=0){let e=this.entryAction[i];e&&e.apply(this),this.stateIndex=i}}initObjectBasedFSM(){let t=new y(this.turnToPoint),s=new y(this.moveForward),i=new y(this.chasePlayer),e=new a(t,s,this.isFacingPoint),o=new a(t,i,this.isPlayerCloseToGem),d=new a(s,t,this.isOverPoint,this.nextPoint),p=new a(s,i,this.isPlayerCloseToGem),r=new a(i,t,this.isPlayerFarFromGem);this.fsm=new w(t,[e,o,d,p,r]),this.update=this.updateUsingObjects}updateUsingObjects(){this.fsm.update(this)}turnTo(t,s){let i=2*this.speed*c,e=g(this.x,this.y,this.dir,t,s),o=e<0?Math.max(e,-i):Math.min(e,i);this.dir+=o}nextPoint(){this.currentPoint=(this.currentPoint+1)%this.patrolPoints.length}isFacingPoint(){let t=this.patrolPoints[this.currentPoint],s=g(this.x,this.y,this.dir,t.x,t.y);return Math.abs(s)<c}isPlayerCloseToGem(){return m(this.enemy.x,this.enemy.y,this.precious.x,this.precious.y)<200}isPlayerFarFromGem(){return!this.isPlayerCloseToGem()}isOverPoint(){let t=this.patrolPoints[this.currentPoint];return m(this.x,this.y,t.x,t.y)<this.speed}draw(){let t=this.game.canvas.context2d;t.fillStyle="rgb(36, 45, 153)",t.strokeStyle="rgb(255, 255, 255)",t.beginPath(),t.arc(this.x,this.y,this.size,0,2*Math.PI),t.fill(),t.moveTo(this.x,this.y),t.lineTo(this.x+this.size*Math.cos(this.dir),this.y+this.size*Math.sin(this.dir)),t.stroke()}};var b=class{constructor(t){this.canvas=new u(t||"canvas"),this.objs=[],this.reset()}tick(){this.canvas.clear(),this.objs.forEach(t=>{t.update(),t.draw()})}reset(){let t=i=>P(this.canvas.width()-i,i),s=i=>P(this.canvas.height()-i,i);this.canvas.clear(),this.objs=[],new x(this,t(50),s(50)),new v(this,t(50),s(50)),new T(this,t(50),s(50),M(Math.PI,-Math.PI)),this.objs.forEach(i=>i.draw())}start(){this.stop(),this.interval=setInterval(()=>this.tick(),30)}stop(){this.interval&&clearInterval(this.interval)}addGameObj(t){this.objs.push(t)}removeGameObj(t){this.objs=this.objs.filter(s=>s!==t)}};window.onload=()=>{let n=document.getElementById("start_btn"),t=document.getElementById("pause_btn"),s=document.getElementById("reset_btn"),i=new b("canvas");n.onclick=()=>i.start(),t.onclick=()=>i.stop(),s.onclick=()=>i.reset()};})();
//# sourceMappingURL=main.js.map
